# デザインの概要

これにより、技術設計のすべての詳細が説明されます。 [`notes.md`](../notes.md)はおそらくより良いリファレンスです
概要を取得します。 ここで技術設計全体を説明し、個別のドキュメントを作成します。
詳細なメッセージフォーマットなど

## ワークフロー

高レベルのワークフローは次のとおりです。

アクティベーション手順:

-ブートストラップCosmosSDKチェーン
-イーサリアム契約をインストールします

トークン転送の手順:

-元のERC20トークンをETHからCosmosに転送します
-ペグされたトークンをCosmosからETHに転送します
-ETHに設定されているCosmosValidatorを更新します

最初の2つのステップは1回実行され、他の3つのステップは何度も繰り返されます。

## 定義

言葉は重要であり、用語の明確さを求めているため、思考とコミュニケーションを明確にすることができます。
以下で説明する重要な概念は、ここで定義されます。

--`Operator`-これは、Cosmos SDKバリデーターノードを制御する1人または複数の人です。これは、CosmosSDKステーキングセクションでは「valoper」または「ValidatorOperator」とも呼ばれます。
-`フルノード `-これはオペレーターが実行する_Ethereum_フルノードです
--`Validator`-これはCosmosSDK検証ノード(署名ブロック)です
-`Eth Signer`(名前WIP)-これは、2つのチェーン間でトークンを移動するために使用されるトランザクションの署名に使用されるEthereum秘密鍵を保持するオペレーターによって制御される別個のバイナリです。
-`Oracle`(名前WIP)-これは、オペレーターによって制御される別個のバイナリであり、 `クレーム`を送信することによってEthereumチェーンからCosmosチェーンにデータを転送するために使用されるCosmosSDK秘密鍵を保持します。これらのクレームは `Attestationに集約されます`
-`Orchestrator`-`Operator`が使いやすいように `Eth Signer`、` Oracle`、および `Relayer`を組み合わせた単一のバイナリ
--`Relayer`-これはEthereumのGravityコントラクトに更新を送信するノードのタイプです。それはバッチでトランザクションから料金を稼ぎます。
--`RESTサーバー `-これは、検証者ノードまたはオペレーターが制御する別のCosmosSDKノードのいずれかでポート1317で実行されるCosmosSDK「RESTサーバー」です。
-`EthereumRPC`-これはEthereumフルノード用のJSON-RPCサーバーです。
-`Validator Set`-Cosmos SDKチェーン上のバリデーターのセットと、それぞれの投票権。これらは、テンダーミントブロックに署名するために使用されるed25519公開鍵です。
-`Gravity Txpool`-Cosmosのチェーンストアに存在するトランザクションプールです->トランザクションバッチに配置されるのを待っているEthereumトランザクション
-`トランザクションバッチ `-トランザクションバッチは、GravityEthereumコントラクトから同時に送信されるEthereumトランザクションのセットです。これにより、バッチを送信するコストを削減できます。バッチには最大サイズ(現在約100トランザクション)があり、Cosmos-> Ethereumフローにのみ関与します
-`Gravity Batch pool`-格納するチェーンに存在する構造のようなトランザクションプールであり、 `Gravity Tx pool`とは別に、署名または送信中のバッチに配置されたトランザクションを格納します。 「オーケストレーターセット」
--`EthBlockDelay`-すべてのオラクル認証が遅延するイーサリアムブロックの合意された数です。信頼できるイーサリアムフルノードで示されるように、このブロック数が経過するまで、「オーケストレーター」はイーサリアムでイベントが発生したことを証明しません。これにより、短いフォークが形成されてコスモス側で不一致が発生するのを防ぐことができます。考慮されている現在の値は50ブロックです。
-`Observed`-イーサリアムのイベントは、特定のブロック中に設定されたアクティブなCosmosバリデーターの66％の `Eth Signers`がイベントの確認を証明するオラクルメッセージを送信した場合、` Observed`と見なされます。
-`Validator set delta`-これは、現在Gravity Ethereum契約にあるバリデーターセットと、Cosmosチェーンにある実際のバリデーターセットとの違いを表す用語です。バリデーターセットはすべてのブロックを変更する可能性があるため、常にゼロ以外の「バリデーターセットデルタ」が存在することが基本的に保証されています。
--`許可されたバリデーターセットデルタ `-これは許可された最大の`バリデーターセットデルタ `です。このパラメーターは、MsgProposeGravityContractのGravityコントラクトに受け入れるのに十分近いバリデーターセットがあるかどうかを判断するために使用されます。また、バリデーターセットの更新をいつ送信する必要があるかを判断するためにも使用されます。これは、MsgProposeGravityContractを送信できるようになる前のガバナンス投票によって決定されます。
-`Gravity ID`-これは、特定のコントラクトインスタンスのすべてのGravityシグネチャに含める必要があるランダムな32バイトの値です。これはEthereumのコントラクトコンストラクターに渡され、コントラクトがバリデーターセットまたはバリデーターセットのサブセットを共有する可能性がある場合に署名の再利用を防ぐために使用されます。これは、MsgProposeGravityContractを送信できるようになる前のガバナンス投票によっても設定されます。
-`Gravityコントラクトコードハッシュ `-これは、Gravityコントラクトソリディティコードの既知の適切なバージョンのコードハッシュです。これは、ブリッジのどのバージョンが展開されるかを正確に確認するために使用されます。
-`Start Threshold`-これは、ブリッジが動作を開始する前に、オンラインでGravity操作に参加している必要がある総投票力のパーセンテージです。
-`Claim`(名前WIP)-単一の `Orchestrator`インスタンスによって署名されてcosmosに送信されたEthereumイベント
-`Attestation`(名前WIP)-最終的にすべてのオーケストレーターによって「監視」されるクレームの集合体
--`Voucher`-コスモス側のブリッジETHトークンを表します。それらのデノムには、「重力」プレフィックスと、コントラクトアドレスとコントラクトトークンから構築されたハッシュがあります。デノムは、システム内で一意であると見なされます。
--`Counterpart`-`Voucher`へは契約でロックされたETHトークンです
--`Delegatekeys`-`Operator`が `EthSigner`と` Oracle`を設定するとき、 `Validator`アドレスを使用してこれらのキーを含むメッセージを送信することで` DelegateKeys`を割り当てます。イーサリアムでメッセージに署名し、イーサリアムでこの「バリデーター」を表すために使用される1つのデリゲートイーサリアムキーと、「Oracle」メッセージを送信するために使用される1つのデリゲートCosmosキーがあります。
-`Gravity Contract` --` Gravity Contract`は、Ethereum側のすべてのGravityブリッジバンドを保持するEthereum契約です。これには、「DelegateKeys」と正規化された累乗を使用したコスモスバリデーターセットの表現が含まれています。たとえば、バリデーターがCosmosチェーンバリデーターパワーの5％を持っている場合、それらのデリゲートキーは「GravityContract」の投票パワーの5％を持ちます。これらの値は、CosmosチェーンとEthereumチェーンバリデーターセットの同期を維持するために定期的に更新されます。

ここでは、_Operator_が信頼の重要な単位です。各オペレーターは、次の3つの安全なプロセスを維持する責任があります。

1. CosmosSDKバリデーター-署名ブロック
1.完全に同期されたイーサリアムフルノード
1.`オペレーターの `Ethキーで物事に署名する` EthSigner`

## セキュリティ上の懸念

**バリデーターセット**は、背後にステークが付いた実際のキーのセットであり、二重記号などの場合はスラッシュで囲まれています。
不正行為。通常、チェーンのセキュリティは_ValidatorSet_のセキュリティと見なされます。これは
各チェーンですが、私たちのゴールドスタンダードです。 IBCでさえ、関連する両方のバリデーターセットの最小値以上のセキュリティを提供しません。

** Eth Signer **は、バリデーターセットによってメインのCosmosデーモン( `gaiad`または同等のもの)と一緒に実行されるバイナリです。これは純粋にコード編成の問題として存在し、イーサリアムトランザクションへの署名、およびイーサリアムでのイベントの監視とそれらのコスモス状態への移行を担当します。イーサリアムに向かうトランザクションにイーサリアムキーで署名し、イーサリアムからのイベントにCosmosSDKキーで署名します。 _ValidatorSet_によって実行される_EthSigner_によって誤って署名されたメッセージにスラッシュ条件を追加し、_Valiator Set_と同じセキュリティを提供できます。これは、悪意の証拠を検出し、スラッシュする量を決定する別のモジュールです。 _Validator Set_の_Eth Signer_によって署名されたトランザクションが違法または悪意のあるものであると証明できれば、Cosmosチェーン側を大幅に削減し、_Validator Set_のセキュリティを100％提供できる可能性があります。これは、3週間の接着解除にもアクセスできることに注意してください
証拠がすぐに解けたとしても、証拠を大幅に削減できる期間。

** MultiSig Set **は、_Validator Set_の(おそらく古くなった)ミラーですが、Ethereumキーがあり、Ethereumに保存されています
契約する。 _MultiSig Set_が非結合期間よりもはるかに頻繁に更新されることを確認した場合(たとえば、少なくとも週に1回)、
そうすれば、_MultiSig Set_のすべてのメンバーが、不正行為のためにスラッシュ可能なアトムを持っていることを保証できます。ただし、極端な場合
ステークシフトの場合、_MultiSigSet_と_ValidatorSet_はかなり離れている可能性があります。つまり、
_MultiSig Set_のメンバーの多くは、アクティブなバリデーターではなくなり、Ethメッセージを転送する必要がなくなる可能性があります。
したがって、検閲攻撃/非アクティブを回避するために、大幅な変更があるたびにこれも更新する必要があります
バリデーターセット内(例:> 3-5％)。これらの2つの条件を維持する場合、MultiSigセットは同様のレベルの
バリデーターセットとしてのセキュリティ。

現在、バリデーターに対してスラッシュできる3つの条件があります。
**バリデーターセット**、_ EthSigner_が保持するCosmosSDKキーを使用して、イーサリアムからの無効/悪意のあるイベントに署名する、または
_EthSigner_が保持するEthereumキーを使用して無効/悪意のあるEthereumトランザクションに署名します。不正行為のすべての条件ができる場合
これらのセットの1つからの署名に起因し、** Cosmosチェーン**で証明されている場合、Gravityが提供するものであると主張できます。
ペグゾーンバリデーターセットの最小値に等しいセキュリティレベル、またはイーサリアムチェーン50ブロックの再編成。
また、IBC以上のセキュリティを提供します。

## ブートストラップ

Cosmosベースのバイナリをアップグレードして重力モジュールを作成する作業はすでに完了していると想定しています。
それへのアプローチは他の多くの場所で議論されています。ここでは、_アクティベーション_ステップに焦点を当てます。

1.各 `Operator`は、` EthSigner`のEthereumおよびCosmos秘密鍵を生成します。これらのアドレスは、MsgRegisterEthSignerのOperatorsvaloperキーによって署名および送信されます。 `EthSigner`は、すべてのGravityメッセージにこれらの委任されたキーを自由に使用できるようになりました。
1.「重力ID」、「許可されたバリデーターセットデルタ」、「開始しきい値」、「重力契約コードハッシュ」などのブリッジパラメーターに対してガバナンス投票が行われます。
1.既知のコードハッシュと、Cosmosゾーンの現在のバリデーターセットを使用して、Ethereum互換のブロックチェーンにGravityコントラクトをデプロイします。
1.各 `Operator`は、上記のGravity契約アドレスを使用して` EthSigner`を構成する場合と構成しない場合があります。
1.アドレスで構成されている場合、 `EthSigner`は提供されたアドレスをチェックします。契約が検証に合格すると、「Eth Signer」が署名し、MsgProposeGravityContractを送信します。検証は、正しい「重力コントラクトコードハッシュ」と「許可されたバリデーターセットデルタ」内の現在のセットに一致するバリデーターセットを見つけることとして定義されます。
1.「開始しきい値」を超える投票権が同じイーサリアムアドレスでMsgProposeGravityContractを送信した場合、契約アドレスが採用されたと見なされます。
1.バリデーターセットはすぐに変更されるため、契約アドレスで構成されていない「Eth Signers」は、送信のためにCosmosブロックチェーンを監視します。アドレスが送信されると、彼らはそれを検証し、合格した場合は自分で承認します。これにより、有効な契約が提案されると、数秒で承認されるワークフローが実現します。
1.競合状態が意図的に作成され、検証者の電力の66％未満が複数の有効な重力イーサリアム契約を承認した場合、採用プロセスが失敗する可能性があります。この場合、オーケストレーターは、権力の大部分で(または完全な同点の場合はランダムに)契約アドレスを確認し、投票を切り替えます。これにより、「オペレーター」の33％以上が意図的に別の契約アドレスを選択する可能性のあるエッジケースのみが残ります。これはコンセンサスの失敗であり、ブリッジは進行できません。
1.ブリッジの承認プロセスが完了し、契約アドレスが参照対象のストアに配置され、他の操作を進めることができます。

この時点で、適切な_MultiSig Set_とEthereumの契約があり、_Orchestrator Set_の> `start threshold`がオンラインであり、この契約に同意し、Cosmosチェーンがこの契約アドレスを保存していることがわかります。そうして初めて、トークンを転送するためのトランザクションの受け入れを開始できます

注:「開始しきい値」は、ブートストラップのセキュリティ要因です。解放するには67％で十分ですが、オンラインで許容誤差が生じるまで開始したくありません(投票権のわずかな変更で落ちないようにします)。これは、開始する前にすべての_オーケストレーター_が動作していることを保証する度合いに応じて、70、80、90、または95％になる可能性があります。

## ETHからCosmosOracle

すべての `Operators`は` Oracle`バイナリを実行します。この個別のプロセスは、イーサリアムチェーン上の「重力コントラクト」に関連する新しいイベントについてイーサリアムノードを監視します。 `Oracle`が監視するすべてのイベントにはイベントナンスがあります。このナンスは、 `Claim`の一意の調整値です。 `Oracle`が監視する必要のあるすべてのイベントには一意のイベントナンスがあるため、` Claims`はイベントナンスを指定することで常に一意のイベントを参照できます。

-「オラクル」はイーサリアムチェーン上のイベントを監視し、このイベントを「クレーム」にパッケージ化し、このクレームをコスモスチェーンに送信します
-Gravity Cosmosモジュール内で、この `Claim`は、アクティブな` Validator`セットの66％以上が一致する `Claim`を作成すると、` Claim`の詳細と一致する既存の `Attestation`を作成または追加します。与えられた `Attestation``Attestation`が実行されます。これにより、トークンの作成、トークンの書き込み、またはこの特定のイベントに適したものが可能になります。
-バリデーターが単一の「Attestation」で66％を超えることに同意できない場合、オラクルは停止されます。これは、一部のバリデーターが投票を変更するまで、新しいイベントがイーサリアムから中継されないことを意味します。予想されるイーサリアムフォークがあった場合、チェーン自体の活気を危険にさらす可能性があるため、これにはスラッシュ条件はありません。

## コスモスをETHに中継する

-ユーザーがトークンをEthereumに転送する場合、ユーザーはMsgSendToEthを送信します。これにより、アカウントからトークンが引き落とされ、トランザクションが「GravityTxPool」に配置されます。
-誰かが(許可なく)MsgRequestBatchを送信します。これにより、「GravityBatchpool」に新しい「Transactionbatch」が生成されます。このバッチの作成はCosmosSDKで行われ、完全に決定論的であり、「GravityTxPool」のトランザクションから可能な限り最も収益性の高いバッチを作成する必要があります。
  -`TransactionBatch`にはバッチナンスが含まれています。
  -後期も含まれますst`ヴァルセット `
  -このバッチのトランザクションは `Gravity Tx Pool`から削除され、新しいバッチに含めることはできません。
-`Gravity Batch Pool`のバッチは、 `ValidatorSet`の` EthSigners`によって署名されます。
  -`Relayers`は、これらのバッチをGravityコントラクトに送信しようとする可能性があります。バッチに十分な署名( `MultisigSet`の2/3 + 1)がある場合、その送信は成功します。バッチ送信を試みるかどうかの決定は、完全に特定の「リレイヤー」次第です。
-バッチがEthereumに正常に送信されたことが「監視」されると(これには少なくとも「EthBlockDelay」と同じ時間がかかります)、「Gravity BatchPool」内のナンスが低く、まだ正常に送信されていないバッチ送信されたトランザクションは、新しいバッチで試行するために「GravityTxPool」に戻されます。これらのバッチはナンスが低すぎるため、これ以上送信できない可能性があることがわかっているため、これは安全です。

-新しいMsgRequestBatchが入ってくると、現在「重力バッチプール」にあるどのバッチよりも収益性が高い場合を除いて、新しいバッチは生成されません。これは、バッチのバックログがある場合、バッチを送信することで徐々に収益性を高める必要があることを意味します。