# 重力橋

！[重力橋](../gravity-bridge.svg)

重力ブリッジはCosmos <-> Ethereumブリッジであり、[Cosmos Hub](https://github.com/cosmos/gaia)で実行するように設計されており、設計のシンプルさと効率を最大限に高めることに重点を置いています。

Gravityは、Ethereumで発生したERC20アセットをCosmosベースのチェーンに転送してEthereumに戻すことができます。

Cosmosで作成されたアセットをEthereumのERC20表現に転送する機能は、数か月以内に提供されます。

## 状態

重力橋は開発中であり、まもなく監査を受ける予定です。展開と使用の手順は、役立つことを期待して提供されています。

このソフトウェアを使用することの経済的、法的、およびその他のリスクを理解するのはあなたの責任です。機能や安全性を保証するものではありません。 Gravityは完全に自己責任で使用してください。

[公開スタンドアップ](https://www.youtube.com/playlist?list=PL1MwlVJloJeyeE23-UmXeIx2NSxs_CV4b)をご覧になり、最新の開発状況についていくことができます。気軽に参加して質問してください。

-堅実な契約
  -[x]複数のERC20サポート
  -[x] 100以上のバリデーターでテスト済み
  -[x]すべてのスロー条件のユニットテスト
  -[x]イーサリアムに由来する資産の監査
  -[]イーサリアムでのコスモスアセットの発行のサポート
-コスモスモジュール
  -[x]基本的なバリデーターセットの同期
  -[x]基本的なトランザクションバッチの生成
  -[x]イーサリアム->コスモストークン発行
  -[x]コスモス->イーサリアムトークン発行
  -[x]ブートストラップ
  -[x] Genesisファイルの保存/読み込み
  -[x]バリデーターセットの同期エッジケース
  -[x]スラッシュ
  -[x]リレーエッジケース
  -[]トランザクションバッチエッジケース
  -[]イーサリアムでのコスモスアセットの発行のサポート
  - [ ] 監査
-オーケストレーター/リレイヤー
  -[x]バリデーターセット更新リレー
  -[x]イーサリアム->コスモスオラクル
  -[x]トランザクションバッチリレー
  -[] TendermintKMSのサポート
  - [ ] 監査

## 重力橋の設計

-重力橋の完全性への信頼は、コスモス側に固定されています。イーサリアム契約を対象とした不正なバリデーターセットの更新とトランザクションバッチの署名は、コスモスチェーンを大幅に削減することで罰せられます。 Cosmosチェーンを信頼する場合、特定のパラメーター内で操作される限り、Cosmosチェーンによって操作されるGravityブリッジを信頼できます。
-ペグゾーンバリデーターは、信頼できるイーサリアムノードを維持する必要があります。これにより、通常は独立した中継器から生じるすべての信頼とゲーム理論の影響が排除され、設計が大幅に簡素化されます。

## 主要な設計コンポーネント

-Cosmosバリデーターの投票をEthereumにミラーリングする非常に効率的な方法。 Gravity Solidity契約には、125個のバリデーターを備えたCosmos Hubバリデーターセットのスナップショットでテストされた、最大500,000ガス($ 2 @ 20gwei)のバリデーターセットの更新があります。バリデーターセットの投票を検証することは、Gravityが実行しなければならないチェーン操作で最も費用がかかります。高度に最適化されたSolidityコードは、大幅なコスト削減を実現します。既存の橋は、8人の署名者という小さな署名セットのガスコストの2倍以上を負担します。
-コスモスからイーサリアムへのトランザクションはバッチ処理され、バッチの基本コストは約500,000ガス($ 2 @ 20gwei)です。バッチには、ブロックあたりのERC20送信の制限内で任意の数のトランザクションを含めることができるため、大量のブリッジでコストを大幅に償却できます。

## セキュリティを確保する運用パラメータ

-少なくともCosmosの非結合期間(通常は2週間)ごとに1回、 `updateValset`メソッドを呼び出して、Ethereumコントラクトに対してバリデーターセットの更新を行う必要があります。これは、非結合期間より長く更新がない場合、イーサリアム契約によって保存されたバリデーターセットに、不正行為のためにスラッシュできないバリデーターが含まれている可能性があるためです。
-Cosmosフルノードは、イーサリアムからのイベントを検証しません。これらのイベントは、純粋に現在のバリデーターセットの署名に基づいてCosmos状態に受け入れられます。ステークの2/3を超えるバリデーターは、イーサリアムでは発生しなかったイベントをコスモス状態にすることができます。この場合、両方のチェーンのオブザーバーは「アラームを発生させる」必要があります。この機能をリレーに組み込んでいます。

## Dockerを使用して今すぐGravityブリッジを実行します

開発と検証の両方のために、完全な任意のバリデーターCosmosチェーンとtestnetGethチェーンをデプロイするワンボタン統合テストを提供します。生産的な開発には、コードの完全な展開と本番環境での使用を反映した詳細なテスト環境が不可欠であると考えています。

現在、コミットごとに、テスト環境で数百のトランザクション、数十のバリデーターセットの更新、およびいくつかのトランザクションバッチを送信しています。これにより、Gravityブリッジに高レベルの品質保証が提供されます。

テストはこのリポジトリ内のすべてを完全に構築するため、実行にはかなりの時間がかかります。単にブランチにプッシュして、GithubCIにテストの実際の実行を処理させることをお勧めします。

テストを実行するには、dockerをインストールして実行するだけです。

`bashテスト/all-up-test.sh`

特定の機能のためのオプションのテストがあります

バリデーターセットの同期を破ろうとして、Valsetストレスは検証力をランダムに25回変更します

`bash tests/all-up-test.sh VALSET_STRESS`

バッチストレスは、ブリッジを介して300トランザクションを送信し、次に3バッチをEthereumに送り返します。このコードは最大10,000のトランザクションを実行できますが、GithubActionsには馬力がありません。

`bash tests/all-up-test.sh BATCH_STRESS`

Validator outは、必須のイーサリアムノードを実行していないバリデーターをテストします。このバリデーターはスラッシュされ、ブリッジは機能し続けます。

`bash tests/all-up-test.sh VALIDATOR_OUT`

# 開発者ガイド

## 堅実な契約

`solidity`フォルダにあります

`HUSKY_SKIP_INSTALL = 1 npm install`を実行してから、` npm runtypechain`を実行します。

別のターミナルで `npm run evm`を実行してから、

`npm run test`を実行して、テストを実行します。

Solidityファイルを変更した後、 `npm runtypechain`を実行してコントラクトを再コンパイルします
typedefs。

Solidityコントラクトは、Cosmosモジュールテストでもカバーされます。このテストでは、統合テストを実行するたびに、マイクロテストネットの開発コンテナー内のGethテストチェーンに自動的にデプロイされます。

## コスモスモジュール

テスト用にCosmosチェーンとEthereumチェーンを自動的にブートストラップする標準のコンテナーベースの開発環境を提供します。開発環境の標準化と開発のしやすさが重要であると考えておりますので、開発フローに問題が生じた場合は、問題を提出してください。

### ユニットテストに行く

これらはチェーン全体を実行するのではなく、Goモジュールコードの一部を個別にテストします。それらを実行するには、 `/module`に移動し、` maketest`を実行します

### 変更をすばやく手動でテストするには

この方法は、上記のすべてのテストから決定されます。同じコンポーネントを実行しますが、個々のコンポーネントを編集する場合ははるかに高速です。

1.`。/tests/build-container.sh`を実行します
2.`。/tests/start-chains.sh`を実行します
3.新しいターミナルに切り替えて、 `。/tests/run-tests.sh`を実行します
4.または、 `docker exec -itgravity_test_instance/bin/bash`を使用すると、テストコンテナ内のシェルにアクセスできるようになります。

コードを変更し、再度テストする場合は、 `。/tests/start-chains.sh`を再起動して、`。/tests/run-tests.sh`を実行します。

### 説明:

`。/tests/build-container.sh`は、ベースコンテナを構築し、Gravityテストゾーンを初めて構築します。これにより、キャッシュされたGo依存関係を含むDockerコンテナー(ベースコンテナー)が作成されます。

`。/tests/start-chains.sh`は、ベースコンテナに基づいてテストコンテナを起動し、現在のソースコード(行った変更を含む)をそのコンテナにコピーします。次に、キャッシュされたGoの依存関係を利用して、重力テストゾーンを構築します。次に、新しいコードで実行されているCosmosチェーンを開始します。また、Ethereumノードを起動します。これらのノードは、起動したターミナルで実行されたままであり、ログを確認すると便利です。これにより、Gravityリポジトリフォルダーもコンテナーにマウントされることに注意してください。つまり、行った変更はそこに反映されます。

`。/tests/run-tests.sh`は実行中のテストコンテナに接続し、`。/tests/integration-tests.sh`にある統合テストを実行します

### IDEのヒント:

-Solidity拡張機能を有効にして/solidityでVSCodeを起動し、Solidityコントラクトのインラインタイプチェックを取得します
-go拡張機能を有効にして/module/appでVSCodeを起動し、ダミーのコスモスチェーンのインラインタイプチェックを取得します

###コンテナ内での作業

コンテナでテキストエディタを実行していて終了したくない場合や、コンテナの `/に保存されている依存関係を編集している場合など、コンテナを再起動せずにテストネットを変更、再コンパイル、再起動すると便利です。 go/`フォルダ。

このワークフローでは、 `。/tests/reload-code.sh`を使用して、コンテナを再起動せずにテストネットを再コンパイルして再起動できます。

たとえば、VS Codeの「Remote-Container」拡張機能を使用して、 `。/tests/start-chains.sh`で始まる実行中のコンテナーに接続し、コンテナー内のコードを編集して、` ./testsでテストネットを再起動できます。/reload-code.sh`を実行し、 `。/tests/integration-tests.sh`を使用してテストを実行します。

## デバッガー

VS Codeでステッピングデバッガーを使用するには、上記の「コンテナー内での作業」の手順に従いますが、 `。/tests/reload-code.sh1`を使用して1ノードのテストネットをセットアップします。ここで、 `pkillgravityed`でノードを強制終了します。 VS Code内からデバッガーを起動すると、1ノードのデバッグ可能なテストネットが作成されます。